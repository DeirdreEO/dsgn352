<!--

TODO: a key to explain the color scheme.

-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>assignment 06t_bar bar chart</title>
    <script type="text/javascript" src="d3.js"> </script>
    <style type="text/css">
      .canvas {
        display:block;
        margin-left: auto;
        margin-right: auto;
        /*padding: 20px;*/
      }

      .axis, .labels {
        font-size: 9px;
        font-family: sans-serif;
      }
      .labels {
          /*text-transform: uppercase;*/
      }
      /* For the y axis line formatting. */
      .axis path, .axis line {
          fill: none;
          stroke: black;
          shape-rendering: crispEdges;
      }
    </style>
</head>
<body>

  <script type="text/javascript">

      // global variables
        var width = 1000 ;
        var height = 400 ;
        var barPadding = 10 ;
        var margin = 20 ;
        var dataset ;
        var bar_magnification = 25 ;
        var bar_baseline_y_offset = 190 ; // A number to calculate the baseline of the bars.

      // create the top-level svg
        var svg = d3.select("body")
          .append("svg")
          .attr("class", "canvas")
          .attr("width", width)
          .attr("height", height);

      // add a title for the chart
          svg.append ("text")
            .attr("fill", "DarkCyan")
            .attr("x", width / 2)
            .attr("y", 25)
//            .attr("dx", "10px")
//            .attr("dy", ".75em") // What are these for? The above two lines already position the element in the horizontal center, and if it needs to by moved down, the y attribute can be increased.
            .attr("text-anchor", "middle")
            .attr("text-decoration", "underline") // Consider using a CSS class instead of so many inline styles / attributes
            .attr("class", "shadow")
            .text("Boston Bar Yelp Ratings Chart");

        d3.csv ( "bar_bar_chart.csv", function ( error, data ) {

            if ( error ) {
                // This displays an error message in console if the data fails to load.
                console.log ( "There was an error accessing your dataset." ) ;
            }
            else {

                // Assign the local variable 'data', which holds our CSV file info, to the global variable 'dataset'.
                dataset = data ;

                // Define an ordinal scale for the x axis.
                var xScale = d3.scale.ordinal()
                    .domain(d3.range(dataset.length)) // Changed to length of dataset.
                    .rangeRoundBands([margin, width], 0.1) ;

                var max_rating = 5 ;
                var y_axis_starting_coordinate = height - (max_rating * bar_magnification) - bar_baseline_y_offset ; // starting coordinate of y-axis
                var y_axis_ending_coordinate = y_axis_starting_coordinate + (max_rating * bar_magnification) ;
                // Define an linear scale for the y axis.
                var yScale = d3.scale.linear()
                        .domain([max_rating,0]) //Our 5-star scale max and min value
                        .range([y_axis_starting_coordinate, y_axis_ending_coordinate]) ;

                // Add the bars.
                d3
                  .select("svg")
                  .selectAll("rect")
          		  .data(dataset)
          		  .enter()
          		  .append("rect")
                  .attr("x", function ( data, index ) {
                    return xScale ( index ) ;
                  })
                  .attr("y", function ( data ) {
                        return height - (data.Rating * bar_magnification) - bar_baseline_y_offset ; // Height minus data value
                  })
                  .attr("width", xScale.rangeBand())// Use the xScale to dynamically set the width of the bar to width / dataset.length - barPadding. See page 137 in IDVFTW.
                  .attr("height", function ( data ) {
                            return data.Rating * bar_magnification ;
                  })
                  .attr("fill", function ( data ) {
                        if ( data.City == "Boston" ) {
                          return "DarkCyan" ;
                        }
                        if ( data.City == "Cambridge" ) {
                          return "Cornflowerblue" ;
                        }
                        if ( data.City == "Somerville" ) {
                          return "Coral" ;
                        }
                    });

                // Add the labels.
                var label_bar_gutter = 7 ; // Provides a little distance between the bars and labels, used three lines below.
                    svg.append("g")
                      .attr("class", "labels")
                      .attr("transform", "translate("+margin+"," + (y_axis_ending_coordinate+label_bar_gutter) + ") rotate(-90)")
                      // 1) Move the group of labels right by 20 pixels, then push it down to just below the bar baseline.
                      // 2) Rotate the group of labels counter-clockwise by 90 degrees
                      .selectAll("text")
                      .data(dataset)
                      .enter()
                      .append("text")
                      .text( function ( data ) {
                            return data.Name;
                      })
                      .attr("x", function ( data, index ) {
                            return 0 ;
                      })
                      .attr("y", function ( data, index ) {
                                var spacing_adjustment = 2 ; // Just shave a little off for the line below.
                                return xScale ( index ) - spacing_adjustment; // This proportionally spaces the labels out so they align nicely with the bars.
                      })
                      .style ("text-anchor", "end") ; // Right-align the labels which, when rotated, top-aligns them.

                // Define y axis.
                var yAxis = d3.svg.axis()
                        .scale(yScale)
                        .orient("left")
                        .ticks(6) ;

                // Draw y axis.
                svg.append("g")
                        .attr("class", "axis")
                        .attr("transform","translate(20)") // Move the axis to the right 20 pixels.
                        .call(yAxis);

            }

        });

  </script>
</body>
</html>
